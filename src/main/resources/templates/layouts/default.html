<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    lang="en"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:title-patterns="$LAYOUT_TITLE - $CONTENT_TITLE">FastPass JAVA SDK</title>
    <!-- Favicon -->
    <link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">
    <link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
    <link rel="apple-touch-icon" th:href="@{/favicon.ico}">
    <!-- Tailwindcss-->
    <link rel="stylesheet" th:href="@{/css/main.css}">

    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>

    <!-- Toast Notification System -->
    <script th:src="@{/js/toast.js}"></script>

    <!-- HTMX Indicator Styles + Mini Sidebar Styles -->
    <style>
        .htmx-indicator {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }
        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator {
            opacity: 1;
        }

        /* Mini Sidebar Styles */
        .sidebar-mini #hs-application-sidebar {
            width: 4.5rem;
        }
        .sidebar-mini #app-header {
            padding-left: 4.5rem;
        }
        .sidebar-mini #main-content {
            padding-left: 4.5rem;
        }
        .sidebar-mini .sidebar-text {
            display: none;
        }
        .sidebar-mini .sidebar-arrow {
            display: none !important;
        }
        .sidebar-mini .sidebar-header {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            display: flex;
            justify-content: center;
        }
        .sidebar-mini .sidebar-logo-full {
            display: none;
        }
        .sidebar-mini .sidebar-logo-mini {
            display: block;
        }
        .sidebar-mini .sidebar-link {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }
        .sidebar-mini .sidebar-footer {
            padding: 0.5rem;
        }
        .sidebar-mini .sidebar-footer .sidebar-text {
            display: none;
        }
        .sidebar-mini .sidebar-accordion .hs-accordion-toggle {
            justify-content: center;
        }

        /* Mini Sidebar - Allow submenu popup to overflow */
        .sidebar-mini #hs-application-sidebar {
            overflow: visible !important;
        }
        .sidebar-mini #hs-application-sidebar > div {
            overflow: visible !important;
        }
        .sidebar-mini #hs-application-sidebar .overflow-y-auto {
            overflow: visible !important;
        }

        /* Mini Sidebar - Submenu Popup on Hover */
        .sidebar-mini .sidebar-accordion {
            position: static;
        }
        .sidebar-mini .sidebar-accordion .sidebar-submenu {
            display: none !important;
            position: fixed;
            min-width: 180px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            z-index: 9999;
        }
        .sidebar-mini .sidebar-accordion:hover .sidebar-submenu {
            display: block !important;
        }
        .sidebar-mini .sidebar-accordion .sidebar-submenu ul {
            padding-left: 0 !important;
        }
        .sidebar-mini .sidebar-accordion .sidebar-submenu li a {
            padding: 0.5rem 0.75rem;
            white-space: nowrap;
        }

        /* Dark mode support for popup submenu */
        .dark .sidebar-mini .sidebar-accordion .sidebar-submenu {
            background: #262626;
            border-color: #404040;
        }

        /* Expanded state (default on lg screens) */
        @media (min-width: 1024px) {
            #hs-application-sidebar {
                width: 16rem;
                transition: width 300ms ease-in-out;
            }
            #app-header {
                transition: padding-left 300ms ease-in-out;
            }
            #main-content {
                transition: padding-left 300ms ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-stone-200 min-h-screen dark:bg-neutral-900">
    <!-- Sticky Header -->
    <div th:replace="~{fragments/header::header}"></div>

    <!-- ========== MAIN CONTENT ========== -->
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar::sidebar}"></div>
    <!-- End Sidebar -->

    <!-- Main content (offset for sidebar) -->
    <div id="main-content" class="w-full pt-4 lg:ps-64 transition-all duration-300">
        <div class="px-4 sm:px-6 lg:px-8">
            <div layout:fragment="content" class="content min-h-screen"></div>
        </div>
    </div>

    <div th:replace="~{fragments/footer::footer}"></div>
    <script th:src="@{/js/preline.js}"></script>
    <script>
        // Dark Mode - Apply before page renders to prevent flash
        (function() {
            const savedDarkMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedDarkMode === 'true' || (savedDarkMode === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();

        window.addEventListener('DOMContentLoaded', () => {
            window.HSStaticMethods.autoInit();

            // Dark Mode Toggle Functionality
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const sunIcon = document.getElementById('dark-mode-sun');
            const moonIcon = document.getElementById('dark-mode-moon');

            // Function to update dark mode icons
            function updateDarkModeIcons(isDark) {
                if (sunIcon && moonIcon) {
                    if (isDark) {
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                    } else {
                        sunIcon.classList.add('hidden');
                        moonIcon.classList.remove('hidden');
                    }
                }
            }

            // Initialize icons based on current state
            updateDarkModeIcons(document.documentElement.classList.contains('dark'));

            // Dark mode toggle click handler
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    const isDark = document.documentElement.classList.toggle('dark');
                    updateDarkModeIcons(isDark);
                    localStorage.setItem('darkMode', isDark);
                });
            }

            // Mini Sidebar Toggle Functionality
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const collapseIcon = document.getElementById('sidebar-collapse-icon');
            const expandIcon = document.getElementById('sidebar-expand-icon');

            // Check localStorage for saved state
            const savedState = localStorage.getItem('sidebarMini');
            if (savedState === 'true') {
                document.body.classList.add('sidebar-mini');
                if (collapseIcon) collapseIcon.classList.add('hidden');
                if (expandIcon) expandIcon.classList.remove('hidden');
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const isMini = document.body.classList.toggle('sidebar-mini');

                    // Toggle icons
                    if (collapseIcon && expandIcon) {
                        if (isMini) {
                            collapseIcon.classList.add('hidden');
                            expandIcon.classList.remove('hidden');
                        } else {
                            collapseIcon.classList.remove('hidden');
                            expandIcon.classList.add('hidden');
                        }
                    }

                    // Save state to localStorage
                    localStorage.setItem('sidebarMini', isMini);
                });
            }

            // Mini Sidebar - Position submenu popup on hover
            document.querySelectorAll('.sidebar-accordion').forEach(accordion => {
                const toggle = accordion.querySelector('.hs-accordion-toggle');
                const submenu = accordion.querySelector('.sidebar-submenu');

                if (toggle && submenu) {
                    accordion.addEventListener('mouseenter', () => {
                        if (document.body.classList.contains('sidebar-mini')) {
                            const rect = toggle.getBoundingClientRect();
                            submenu.style.left = '4.5rem';
                            submenu.style.top = rect.top + 'px';
                        }
                    });
                }
            });

            // Dynamic Breadcrumb Update Functionality
            const breadcrumbSeparator = document.getElementById('breadcrumb-separator');
            const breadcrumbCurrent = document.getElementById('breadcrumb-current');

            // Function to update breadcrumb
            function updateBreadcrumb(breadcrumbText) {
                if (breadcrumbSeparator && breadcrumbCurrent) {
                    if (breadcrumbText && breadcrumbText.trim() !== '') {
                        breadcrumbSeparator.classList.remove('hidden');
                        breadcrumbCurrent.classList.remove('hidden');
                        breadcrumbCurrent.textContent = breadcrumbText;
                    } else {
                        breadcrumbSeparator.classList.add('hidden');
                        breadcrumbCurrent.classList.add('hidden');
                        breadcrumbCurrent.textContent = '';
                    }
                }
            }

            // Attach click listeners to sidebar navigation links
            document.querySelectorAll('.sidebar-nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const breadcrumbText = this.dataset.breadcrumb;
                    updateBreadcrumb(breadcrumbText);
                });
            });

            // Also handle HTMX afterSwap for dynamic content updates
            document.body.addEventListener('htmx:afterSwap', function(event) {
                // Re-attach click listeners after HTMX swaps content
                document.querySelectorAll('.sidebar-nav-link').forEach(link => {
                    link.removeEventListener('click', handleBreadcrumbClick);
                    link.addEventListener('click', handleBreadcrumbClick);
                });
            });

            function handleBreadcrumbClick() {
                const breadcrumbText = this.dataset.breadcrumb;
                updateBreadcrumb(breadcrumbText);
            }
        });
    </script>
</body>
</html>
