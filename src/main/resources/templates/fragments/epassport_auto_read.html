<html xmlns:th="http://www.thymeleaf.org">
  <div id="response" th:fragment="e-passport-auto-read" class="min-h-screen pb-8">
    <!-- Gradient Header Section with Icon -->
    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-800 p-6 mb-6 shadow-lg">
      <div class="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]"></div>
      <div class="relative flex items-center justify-between">
        <div class="flex items-center gap-4">
          <!-- Passport Icon -->
          <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3">
            <svg class="size-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5zm6-10.125a1.875 1.875 0 11-3.75 0 1.875 1.875 0 013.75 0zm1.294 6.336a6.721 6.721 0 01-3.17.789 6.721 6.721 0 01-3.168-.789 3.376 3.376 0 016.338 0z" />
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white tracking-wide">E-Passport Auto Read</h1>
            <p class="text-lg text-blue-100">Automatic passport scanning and chip data extraction</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <!-- WebSocket Connection Status -->
          <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-lg px-3 py-2 border border-white/20">
            <span class="flex size-3 relative">
              <span id="connection-pulse" class="hidden animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span id="connection-dot" class="relative inline-flex rounded-full size-3 bg-gray-400"></span>
            </span>
            <span id="connection-status-text" class="text-sm text-white">Not Connected</span>
          </div>
          <button
            id="auto-read-button"
            type="button"
            class="inline-flex items-center gap-x-2 rounded-xl bg-white/20 backdrop-blur-sm px-4 py-2.5 text-sm font-semibold text-white hover:bg-white/30 transition-all duration-200 border border-white/30"
            onclick="startAutoRead()"
          >
            <svg class="hidden animate-spin size-4" id="auto-read-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span id="auto-read-button-text">RUN AUTO READ</span>
          </button>
        </div>
      </div>
      <!-- Progress Indicator (Hidden by default) -->
      <div id="read-progress-container" class="hidden mt-4">
        <div class="flex justify-between items-center mb-1">
          <span id="read-progress-text" class="text-xs font-medium text-white">Reading...</span>
          <span id="read-progress-percent" class="text-xs font-medium text-white">0%</span>
        </div>
        <div class="flex w-full h-2 bg-white/20 rounded-full overflow-hidden">
          <div id="read-progress-bar" class="flex flex-col justify-center rounded-full overflow-hidden bg-white text-xs text-blue-600 text-center whitespace-nowrap transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Passport Header -->
    <div class="px-4 sm:px-0 mb-2">
      <div th:replace="~{fragments/passport_cards :: passportHeader(
        mrzInfo=${null},
        countryFlagId='country-flag',
        passportNumberSpanId='span-passport-number',
        nameSpanId='span-name'
      )}"></div>
    </div>

    <!-- Tab Navigation -->
    <div class="px-4 sm:px-0 mb-2">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button
            onclick="switchTabAuto('emrtd')"
            id="tab-emrtd"
            class="tab-button-auto border-blue-500 text-blue-600 whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium"
          >
            E-MRTD Data
          </button>
          <button
            onclick="switchTabAuto('sod')"
            id="tab-sod"
            class="tab-button-auto border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium"
          >
            SOD Information
          </button>
          <button
            onclick="switchTabAuto('pa')"
            id="tab-pa"
            class="tab-button-auto border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium"
          >
            Passive Authentication
          </button>
          <button
            onclick="switchTabAuto('log')"
            id="tab-log"
            class="tab-button-auto border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium"
          >
            Event Log
          </button>
        </nav>
      </div>
    </div>

    <!-- Tab Content Container -->
    <div class="px-4 sm:px-0">
      <!-- E-MRTD Data Tab Content (default visible) -->
      <div id="content-emrtd" class="tab-content-auto">
        <!-- Main Grid: 3 rows × 3 columns -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Row 1, Col 1: Photo Comparison -->
          <div th:replace="~{fragments/passport_cards :: photoComparison(
            vizPhotoData=${null},
            epassPhotoData=${null},
            vizPhotoId='viz-photo',
            epassPhotoId='epass-photo'
          )}"></div>

          <!-- Row 1, Col 2: Personal Information -->
          <div th:replace="~{fragments/passport_cards :: personalInfo(
            mrzInfo=${null},
            docTypeId='doc-type',
            issuingStateId='issuing-state',
            passportNumberId='passport-number',
            nameId='name',
            nationalityId='nationality',
            birthId='birth',
            sexId='sex',
            expiryDateId='expiry-date'
          )}"></div>

          <!-- Row 1, Col 3: Data Group Read Results -->
          <div th:replace="~{fragments/passport_cards :: dgResults(
            ePassResults=${null},
            idPrefix='auto'
          )}"></div>

          <!-- Row 2, Col 1-2: MRZ Image (spans 2 columns) -->
          <div th:replace="~{fragments/passport_cards :: mrzImageCard(
            mrzImageData=${null},
            mrzLines=${null},
            mrzPhotoId='mrz-photo',
            mrzLine1Id='mrz-line-1',
            mrzLine2Id='mrz-line-2'
          )}"></div>

          <!-- Row 2, Col 3: Authentication Results -->
          <div th:replace="~{fragments/passport_cards :: authResults(
            ePassResults=${null},
            idPrefix='auto'
          )}"></div>

          <!-- Row 3, Col 1-3: Document Images (spans all 3 columns) -->
          <div th:replace="~{fragments/passport_cards :: documentImages(
            whImageData=${null},
            irImageData=${null},
            uvImageData=${null},
            whImageId='wh-image',
            irImageId='ir-image',
            uvImageId='uv-image'
          )}"></div>
        </div>
      </div>

      <!-- SOD Information Tab Content -->
      <div id="content-sod" class="tab-content-auto hidden">
        <div th:replace="~{fragments/sod_tab_content :: sodTabContent(
          containerId='auto-sod-info-container',
          emptyStateId='auto-sod-empty-state'
        )}"></div>
      </div>

      <!-- PA Tab Content -->
      <div id="content-pa" class="tab-content-auto hidden">
        <div th:replace="~{fragments/pa_tab_content :: paTabContent(
          btnId='auto-verify-pa-btn',
          containerId='auto-pa-result-container',
          emptyStateId='auto-pa-empty-state',
          prefix='auto'
        )}"></div>
      </div>

      <!-- Event Log Tab Content -->
      <div id="content-log" class="tab-content-auto hidden">
        <!-- Log Messages Section -->
        <div class="border rounded-lg border-gray-200 bg-white shadow-sm">
          <!-- Log Header with Clear Button -->
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
            <h4 class="font-semibold text-gray-900 flex items-center gap-2">
              <svg class="size-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
              </svg>
              Event Log
            </h4>
            <div class="flex gap-2">
              <button
                id="log-auto-scroll-toggle"
                type="button"
                class="inline-flex items-center gap-x-1.5 rounded-lg px-2.5 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors"
                title="Toggle auto-scroll"
              >
                <svg class="size-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
                </svg>
                <span id="auto-scroll-status">Auto-scroll: ON</span>
              </button>
              <button
                id="clear-log-button"
                type="button"
                class="inline-flex items-center gap-x-1.5 rounded-lg px-2.5 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors"
                onclick="clearLog()"
              >
                <svg class="size-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                </svg>
                Clear
              </button>
            </div>
          </div>

          <!-- Log Content with Auto-scroll -->
          <div id="log-scroll-container" class="overflow-y-auto bg-gray-50" style="max-height: 400px;">
            <div id="notifications" class="p-3 font-mono text-xs text-gray-700 space-y-1">
              <div class="text-gray-400 italic">Waiting for events...</div>
            </div>
          </div>

          <!-- Log Footer with Stats -->
          <div class="px-4 py-2 border-t border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between text-xs text-gray-500">
              <span>Total events: <span id="log-event-count" class="font-semibold text-gray-700">0</span></span>
              <span id="log-last-update">No events yet</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared Passport Tabs JavaScript -->
  <script th:src="@{/js/passport-tabs.js}"></script>
  <!-- PA Verification JavaScript -->
  <script th:src="@{/js/pa-verification.js}"></script>

  <script>
    // Global state management
    let autoScrollEnabled = true;
    let eventCount = 0;
    let readProgress = 0;
    const progressSteps = {
      'FPHPS_EV_VIZ_PHOTO_CAPTURED': 15,
      'FPHPS_EV_EPASS_READ_FACE': 30,
      'FPHPS_EV_IR_MRZ_IMAGE_CAPTURED': 45,
      'FPHPS_EV_DOC_FRAME_FOUND': 60,
      'FPHPS_EV_WH_IMAGE_CAPTURED': 70,
      'FPHPS_EV_IR_IMAGE_CAPTURED': 80,
      'FPHPS_EV_UV_IMAGE_CAPTURED': 90,
      'FPHPS_EV_EPASS_READ_DONE': 100
    };

    // Tab switching function
    function switchTabAuto(tabName) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content-auto');
      tabContents.forEach(content => content.classList.add('hidden'));

      // Remove active styling from all tabs
      const tabButtons = document.querySelectorAll('.tab-button-auto');
      tabButtons.forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
      });

      // Show selected tab content
      const selectedContent = document.getElementById(`content-${tabName}`);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }

      // Add active styling to selected tab
      const selectedTab = document.getElementById(`tab-${tabName}`);
      if (selectedTab) {
        selectedTab.classList.remove('border-transparent', 'text-gray-500');
        selectedTab.classList.add('border-blue-500', 'text-blue-600');
      }
    }

    // WebSocket connection setup
    const socket = new WebSocket("ws://localhost:8080/fastpass");

    // Connection opened
    socket.onopen = function(event) {
      console.log("WebSocket connected");
      updateConnectionStatus(true);
      addLogEntry("System", "WebSocket connected successfully");
    };

    // Connection closed
    socket.onclose = function(event) {
      console.log("WebSocket disconnected");
      updateConnectionStatus(false);
      addLogEntry("System", "WebSocket disconnected", "error");
    };

    // Connection error
    socket.onerror = function(error) {
      console.error("WebSocket error:", error);
      updateConnectionStatus(false);
      addLogEntry("System", "WebSocket connection error", "error");
    };

    // Message received
    socket.onmessage = function (event) {
      const message = JSON.parse(event.data);

      // 모든 이벤트에서 parsedSOD 확인 - 공유 함수 사용
      if (message.parsedSOD) {
        console.log("ParsedSOD found in event:", message.eventCodeString);
        console.log("ParsedSOD data:", message.parsedSOD);
        // 공유 JavaScript의 renderSODInformation 함수 사용 (새 컨테이너 ID 전달)
        renderSODInformation(message.parsedSOD, 'auto-sod-info-container');
      }

      // Add log entry for all events
      const eventName = message.eventCodeString?.replace('FPHPS_EVENTS.FPHPS_EV_', '') || 'UNKNOWN';
      addLogEntry(eventName, message.lParam || 'Event received');

      // Update progress if applicable
      updateProgress(eventName);

      switch (message.eventCodeString) {
        case "FPHPS_EVENTS.FPHPS_EV_VIZ_PHOTO_CAPTURED":
          var el = document.querySelector("#viz-photo");
          el.setAttribute("src", "data:image/png;base64, " + message.image.imageData);
          break;
        case "FPHPS_EVENTS.FPHPS_EV_EPASS_READ_FACE":
          var el = document.querySelector("#epass-photo");
          el.setAttribute("src", "data:image/png;base64, " + message.image.imageData);
          break;
        case "FPHPS_EVENTS.FPHPS_EV_IR_MRZ_IMAGE_CAPTURED":
          var el = document.querySelector("#mrz-photo");
          el.setAttribute("src", "data:image/png;base64, " + message.image.imageData);
          break;
        case "FPHPS_EVENTS.FPHPS_EV_WH_IMAGE_CAPTURED":
          var el = document.querySelector("#wh-image");
          el.setAttribute("src", "data:image/png;base64, " + message.image.imageData);
          break;
        case "FPHPS_EVENTS.FPHPS_EV_IR_IMAGE_CAPTURED":
          var el = document.querySelector("#ir-image");
          el.setAttribute("src", "data:image/png;base64, " + message.image.imageData);
          break;
        case "FPHPS_EVENTS.FPHPS_EV_UV_IMAGE_CAPTURED":
          var el = document.querySelector("#uv-image");
          el.setAttribute("src", "data:image/png;base64, " + message.image.imageData);
          break;
        case "FPHPS_EVENTS.FPHPS_EV_EPASS_READ_DONE":
          console.log("E-Passport read completed");
          // Reset button state and prepare for next read
          resetAutoReadButton();
          addLogEntry("System", "E-Passport read completed successfully", "success");
          break;
        case "FPHPS_EVENTS.FPHPS_EV_PAGE_CAPTURED":
          console.log("ePassResults: ", message.ePassResults);
          console.log("parsedSOD: ", message.parsedSOD);

          // Update DG checkboxes (using new fragment ID format: auto-dg1, auto-dg2, ...)
          for (let i = 1; i <= 16; i++) {
            const checkbox = document.querySelector(`#auto-dg${i}`);
            if (checkbox) checkbox.checked = message.ePassResults.dgs[i - 1];
          }

          // Update auth checkboxes and labels (using new fragment ID format)
          const authFields = ['bac', 'pa', 'aa', 'ca', 'ta', 'sac'];
          authFields.forEach(field => {
            const checkbox = document.querySelector(`#auto-auth-${field}`);
            const label = document.querySelector(`#auto-label-auth-${field}`);
            if (checkbox) checkbox.checked = message.ePassResults[field];
            if (label) label.innerHTML = message.ePassResults[field + 'ResultDesc'];
          });
          break;
        case "FPHPS_EVENTS.FPHPS_EV_DOC_FRAME_FOUND":
          var el = document.getElementById("mrz-line-1");
          if (el) {
            var line1 = message.mrzLines.line1.replace(/</g, "&lt");
            el.innerHTML = line1;
          }
          el = document.getElementById("mrz-line-2");
          if (el) el.innerHTML = message.mrzLines.line2;

          var mrzInfo = message.mrzInfo;
          el = document.querySelector("#country-flag");
          if (el) el.setAttribute("src", mrzInfo.countryFlagUrl);
          el = document.getElementById("span-passport-number");
          if (el) el.innerHTML = mrzInfo.passportNumber;
          el = document.getElementById("span-name");
          if (el) el.innerHTML = mrzInfo.name;
          el = document.getElementById("doc-type");
          if (el) el.innerHTML = mrzInfo.docType;
          el = document.getElementById("issuing-state");
          if (el) el.innerHTML = mrzInfo.issuingState;
          el = document.getElementById("name");
          if (el) el.innerHTML = mrzInfo.name;
          el = document.getElementById("passport-number");
          if (el) el.innerHTML = mrzInfo.passportNumber;
          el = document.getElementById("nationality");
          if (el) el.innerHTML = mrzInfo.nationality;
          el = document.getElementById("birth");
          if (el) el.innerHTML = mrzInfo.birth;
          el = document.getElementById("sex");
          if (el) el.innerHTML = mrzInfo.sex;
          el = document.getElementById("expiry-date");
          if (el) el.innerHTML = mrzInfo.expiryDate;
          break;
        default:
          break;
      }
    };

    // ========== Utility Functions ==========

    // Reset Auto Read button state after read completion
    function resetAutoReadButton() {
      const button = document.getElementById('auto-read-button');
      const spinner = document.getElementById('auto-read-spinner');
      const buttonText = document.getElementById('auto-read-button-text');
      const progressContainer = document.getElementById('read-progress-container');
      const progressBar = document.getElementById('read-progress-bar');

      console.log('resetAutoReadButton called');

      if (button) {
        button.disabled = false;
        // HTMX가 추가한 클래스들도 제거
        button.classList.remove('htmx-request');
        // HTMX 내부 상태 초기화를 위해 속성 제거
        button.removeAttribute('data-htmx-request');
        console.log('Button reset: disabled =', button.disabled);
      }
      if (spinner) {
        spinner.classList.add('hidden');
      }
      if (buttonText) {
        buttonText.textContent = 'Start Auto Read';
      }

      // Hide progress bar after a short delay
      setTimeout(() => {
        if (progressContainer) {
          progressContainer.classList.add('hidden');
        }
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        readProgress = 0;
      }, 2000);
    }

    // Update WebSocket connection status
    function updateConnectionStatus(isConnected) {
      const dot = document.getElementById('connection-dot');
      const pulse = document.getElementById('connection-pulse');
      const statusText = document.getElementById('connection-status-text');

      if (isConnected) {
        dot.classList.remove('bg-gray-400', 'bg-red-500');
        dot.classList.add('bg-green-500');
        pulse.classList.remove('hidden');
        statusText.textContent = 'Connected';
        statusText.classList.remove('text-gray-600', 'text-red-600');
        statusText.classList.add('text-green-600');
      } else {
        dot.classList.remove('bg-green-500', 'bg-gray-400');
        dot.classList.add('bg-red-500');
        pulse.classList.add('hidden');
        statusText.textContent = 'Disconnected';
        statusText.classList.remove('text-green-600', 'text-gray-600');
        statusText.classList.add('text-red-600');
      }
    }

    // Add log entry with timestamp
    function addLogEntry(eventName, message, type = 'info') {
      const logContainer = document.getElementById('notifications');
      const scrollContainer = document.getElementById('log-scroll-container');

      // Remove placeholder if present
      const placeholder = logContainer.querySelector('.text-gray-400.italic');
      if (placeholder) {
        logContainer.innerHTML = '';
      }

      const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });

      const logEntry = document.createElement('div');
      logEntry.className = 'flex gap-2 items-start py-1 border-b border-gray-100 last:border-0';

      let colorClass = 'text-blue-600';
      let icon = '●';
      if (type === 'error') {
        colorClass = 'text-red-600';
        icon = '✕';
      } else if (type === 'success') {
        colorClass = 'text-green-600';
        icon = '✓';
      } else if (type === 'warning') {
        colorClass = 'text-yellow-600';
        icon = '⚠';
      }

      logEntry.innerHTML = `
        <span class="${colorClass} font-bold">${icon}</span>
        <span class="text-gray-400">[${timestamp}]</span>
        <span class="font-semibold text-gray-700">${eventName}:</span>
        <span class="text-gray-600">${message}</span>
      `;

      logContainer.appendChild(logEntry);

      // Update event count
      eventCount++;
      document.getElementById('log-event-count').textContent = eventCount;
      document.getElementById('log-last-update').textContent = `Last: ${timestamp}`;

      // Auto-scroll if enabled
      if (autoScrollEnabled) {
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
      }
    }

    // Clear log
    function clearLog() {
      const logContainer = document.getElementById('notifications');
      logContainer.innerHTML = '<div class="text-gray-400 italic">Log cleared. Waiting for events...</div>';
      eventCount = 0;
      document.getElementById('log-event-count').textContent = '0';
      document.getElementById('log-last-update').textContent = 'No events yet';
    }

    // Toggle auto-scroll
    document.getElementById('log-auto-scroll-toggle')?.addEventListener('click', function() {
      autoScrollEnabled = !autoScrollEnabled;
      const statusSpan = document.getElementById('auto-scroll-status');
      statusSpan.textContent = `Auto-scroll: ${autoScrollEnabled ? 'ON' : 'OFF'}`;
      this.classList.toggle('bg-gray-100', autoScrollEnabled);
    });

    // Update read progress
    function updateProgress(eventName) {
      const progressContainer = document.getElementById('read-progress-container');
      const progressBar = document.getElementById('read-progress-bar');
      const progressText = document.getElementById('read-progress-text');
      const progressPercent = document.getElementById('read-progress-percent');

      // Check if this event has a progress step
      const progress = progressSteps[eventName];
      if (progress !== undefined) {
        readProgress = progress;

        // Show progress container
        progressContainer.classList.remove('hidden');

        // Update progress bar
        progressBar.style.width = `${progress}%`;
        progressPercent.textContent = `${progress}%`;

        // Update progress text
        const progressMessages = {
          15: 'Capturing document photo...',
          30: 'Reading e-passport chip...',
          45: 'Extracting MRZ data...',
          60: 'Processing document info...',
          70: 'Capturing white light image...',
          80: 'Capturing infrared image...',
          90: 'Capturing UV image...',
          100: 'Read completed!'
        };
        progressText.textContent = progressMessages[progress] || 'Processing...';

        // If completed, hide after delay
        if (progress === 100) {
          setTimeout(() => {
            progressContainer.classList.add('hidden');
            readProgress = 0;
            progressBar.style.width = '0%';
          }, 3000);
        }
      }
    }

    // Start Auto Read function - Called directly by button onclick
    // Using fetch API instead of HTMX for more reliable control
    async function startAutoRead() {
      const button = document.getElementById('auto-read-button');
      const spinner = document.getElementById('auto-read-spinner');
      const buttonText = document.getElementById('auto-read-button-text');
      const progressContainer = document.getElementById('read-progress-container');
      const progressBar = document.getElementById('read-progress-bar');

      // Prevent multiple clicks
      if (button.disabled) {
        console.log('Button is already disabled, ignoring click');
        return;
      }

      console.log('startAutoRead() called');

      // Update button state
      button.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      if (buttonText) buttonText.textContent = 'Reading...';

      // Reset and show progress
      readProgress = 0;
      if (progressContainer) progressContainer.classList.remove('hidden');
      if (progressBar) progressBar.style.width = '0%';

      addLogEntry('System', 'Auto read started', 'info');

      try {
        const response = await fetch('/passport/run-auto-read', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        });

        console.log('Auto read request completed, status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // Request succeeded - actual read completion will be signaled via WebSocket
        // Do NOT reset button here, wait for FPHPS_EV_EPASS_READ_DONE event

      } catch (error) {
        console.error('Auto read request failed:', error);
        addLogEntry('System', `Auto read request failed: ${error.message}`, 'error');
        // Reset button on error
        resetAutoReadButton();
      }
    }
  </script>
</html>